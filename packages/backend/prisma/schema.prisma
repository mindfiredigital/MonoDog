// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id    Int    @id @default(autoincrement())
  name  String
  email String @unique
  posts Post[]
}

model Post {
  id        Int     @id @default(autoincrement())
  title     String
  content   String?
  published Boolean @default(false)
  authorId  Int
  author    User    @relation(fields: [authorId], references: [id])
}

// --- MONOREPO DATA MODEL ---

/// Represents a single package within the monorepo, based on the pnpm/package.json data.
model Package {
  // Primary Key and Identity Field (using the package name as the unique ID)
  // Example: '@monodog/dashboard'
  name String @id @unique

  // Core Package Metadata
  version String
  type    String // e.g., 'app', 'package'

  // Timestamps
  createdAt   DateTime @default(now())
  lastUpdated DateTime @default(now())

  // Key Metrics and Relationships
  dependencies String? // The total number of direct dependencies
  // Manual Serialization Required: Stores a JSON array string of maintainers, e.g., '["team-frontend"]'
  maintainers  String
  // Manual Serialization Required: Stores a JSON array string of tags, e.g., '["core", "ui"]'
  path         String // The relative path in the file system, e.g., 'apps/dashboard'

  // Descriptions and Configuration
  description String
  license     String
  repository  String?

  // Manual Serialization Required: Stores the scripts object as a JSON string
  // Example: '{"dev": "vite", "build": "tsc && vite build"}'
  scripts String?
  status  String  @default("")

  devDependencies  String?
  peerDependencies String?
  dependenciesInfo DependencyInfo[]
  commits          Commit[]
  packageHealth    PackageHealth?
}

model DependencyInfo {
  name        String
  packageName String
  version     String
  type        String  @default("")
  status      String  @default("")
  latest      String?
  outdated    Boolean @default(false)
  package     Package @relation(fields: [packageName], references: [name])

  @@unique([name, packageName]) // Composite unique constraint
}

model Commit {
  hash        String    @id
  message     String
  author      String
  date        DateTime?
  type        String
  packageName String
  package     Package   @relation(fields: [packageName], references: [name])
}

model HealthStatus {
  id        Int     @id @default(autoincrement())

  // Package reference (without formal relation)
  packageName String @unique
  // package     Package @relation(fields: [packageName], references: [name], onDelete: Cascade)

  // Health Metrics
  overallScore   Float   // Overall health score (0-100)
  buildStatus    String  // e.g., "passing", "failing", "unknown"
  testCoverage   Float   // Test coverage percentage (0-100)
  lintStatus     String  // e.g., "passing", "warning", "failing"
  security       String  // e.g., "secure", "vulnerabilities", "unknown"
  dependencies   String  // e.g., "up-to-date", "outdated", "vulnerable"
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("health_status") // Optional: to specify the table name
}
model PackageHealth {
  id                   Int      @id @default(autoincrement())
  packageName          String   @unique
  packageOverallScore  Float
  packageBuildStatus   String
  packageTestCoverage  Float?
  packageLintStatus    String
  packageSecurity      String    // Changed from securityAudit to packageSecurity
  packageDependencies  String    // Changed from dependencies to packageDependencies
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  package              Package   @relation(fields: [packageName], references: [name])

  @@map("package_health")
}

model HealthStatus {
  id        Int     @id @default(autoincrement())
  
  // Package reference (without formal relation)
  packageName String @unique
  // package     Package @relation(fields: [packageName], references: [name], onDelete: Cascade)

  
  // Health Metrics
  overallScore   Float   // Overall health score (0-100)
  buildStatus    String  // e.g., "passing", "failing", "unknown"
  testCoverage   Float   // Test coverage percentage (0-100)
  lintStatus     String  // e.g., "passing", "warning", "failing"
  security       String  // e.g., "secure", "vulnerabilities", "unknown"
  dependencies   String  // e.g., "up-to-date", "outdated", "vulnerable"
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("health_status") // Optional: to specify the table name
}
model PackageHealth {
  id                   Int      @id @default(autoincrement())
  packageName          String   @unique
  packageOverallScore  Float
  packageBuildStatus   String
  packageTestCoverage  Float?
  packageLintStatus    String
  packageSecurity      String    // Changed from securityAudit to packageSecurity
  packageDependencies  String    // Changed from dependencies to packageDependencies
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@map("package_health")
}